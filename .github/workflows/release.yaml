name: CI and Release

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      workflow_action:
        description: Workflow action to run
        required: true
        type: choice
        options:
          - create_release_pr
          - publish_only
        default: create_release_pr
      release_type:
        description: Version bump type
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      base_branch:
        description: Base branch for release PR
        required: false
        type: string
        default: main

permissions:
  contents: read
  id-token: write

jobs:
  verify:
    name: Lint and Unit Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run lint
        run: yarn lint

      - name: Run unit tests
        run: yarn test:unit

  create_release_pr:
    name: Create Release PR
    runs-on: ubuntu-latest
    needs: verify
    if: github.event_name == 'workflow_dispatch' && inputs.workflow_action == 'create_release_pr'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Bump package version
        id: version
        run: |
          npm version "${{ inputs.release_type }}" --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure git signing for release commit
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          RELEASE_BOT_GIT_NAME: ${{ secrets.RELEASE_BOT_GIT_NAME }}
          RELEASE_BOT_GIT_EMAIL: ${{ secrets.RELEASE_BOT_GIT_EMAIL }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Missing required secret: GPG_PRIVATE_KEY"
            exit 1
          fi

          if [ -z "$RELEASE_BOT_GIT_NAME" ] || [ -z "$RELEASE_BOT_GIT_EMAIL" ]; then
            echo "Missing required secrets: RELEASE_BOT_GIT_NAME and/or RELEASE_BOT_GIT_EMAIL"
            exit 1
          fi

          GNUPGHOME_DIR=$(mktemp -d)
          chmod 700 "$GNUPGHOME_DIR"
          echo "GNUPGHOME=$GNUPGHOME_DIR" >> "$GITHUB_ENV"
          export GNUPGHOME="$GNUPGHOME_DIR"

          printf '%s' "$GPG_PRIVATE_KEY" | gpg --batch --import
          GPG_KEY_FINGERPRINT=$(gpg --batch --list-secret-keys --with-colons | awk -F: '/^fpr:/ { print $10; exit }')

          if [ -z "$GPG_KEY_FINGERPRINT" ]; then
            echo "Unable to determine GPG key fingerprint"
            exit 1
          fi

          if [ -n "$GPG_PASSPHRASE" ]; then
            printf 'pinentry-mode loopback\n' >> "$GNUPGHOME/gpg.conf"
            printf '%s' "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --local-user "$GPG_KEY_FINGERPRINT" --sign --output /dev/null /dev/null
          fi

          git config --global user.name "$RELEASE_BOT_GIT_NAME"
          git config --global user.email "$RELEASE_BOT_GIT_EMAIL"
          git config --global user.signingkey "$GPG_KEY_FINGERPRINT"
          git config --global commit.gpgsign true

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: release/v${{ steps.version.outputs.new_version }}
          base: ${{ inputs.base_branch }}
          author: ${{ secrets.RELEASE_BOT_GIT_NAME }} <${{ secrets.RELEASE_BOT_GIT_EMAIL }}>
          committer: ${{ secrets.RELEASE_BOT_GIT_NAME }} <${{ secrets.RELEASE_BOT_GIT_EMAIL }}>
          commit-message: "chore(release): v${{ steps.version.outputs.new_version }}"
          title: "chore(release): v${{ steps.version.outputs.new_version }}"
          body: |
            Release PR created by workflow.

            - Release type: `${{ inputs.release_type }}`
            - Version: `v${{ steps.version.outputs.new_version }}`
          labels: release
          delete-branch: true

  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: verify
    if: |
      (github.event_name == 'push' && github.ref_name == github.event.repository.default_branch) ||
      (github.event_name == 'workflow_dispatch' && inputs.workflow_action == 'publish_only')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect release merge
        id: release_check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.workflow_action }}" = "publish_only" ]; then
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "new_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CURRENT_VERSION=$(node -p "require('./package.json').version")
          PREVIOUS_VERSION=$(git show HEAD^:package.json 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync(0, 'utf8')).version" || echo "")

          if [ -z "$PREVIOUS_VERSION" ]; then
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "new_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js for npm
        if: steps.release_check.outputs.is_release == 'true'
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn
          registry-url: https://registry.npmjs.org
          token: ""

      - name: Ensure npm supports trusted publishing
        if: steps.release_check.outputs.is_release == 'true'
        run: |
          npm --version
          npm i -g npm@^11.5.1
          npm --version

      - name: Install dependencies
        if: steps.release_check.outputs.is_release == 'true'
        run: yarn install --frozen-lockfile

      - name: Build package
        if: steps.release_check.outputs.is_release == 'true'
        run: yarn build

      - name: Enforce OIDC trusted publishing mode
        if: steps.release_check.outputs.is_release == 'true'
        run: |
          rm -f "$HOME/.npmrc"
          rm -f "$NPM_CONFIG_USERCONFIG"
          npm config delete //registry.npmjs.org/:_authToken || true

      - name: Check OIDC availability
        if: steps.release_check.outputs.is_release == 'true'
        run: |
          if [ -z "$ACTIONS_ID_TOKEN_REQUEST_URL" ] || [ -z "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
            echo "OIDC token request variables are missing in this job"
            exit 1
          fi

      - name: Debug npm auth context
        if: steps.release_check.outputs.is_release == 'true'
        run: |
          node --version
          npm --version
          npm config get registry
          npm config list -l | sed -n '/; userconfig/,+30p'
          env | grep -E '^(ACTIONS_ID_TOKEN_REQUEST_URL|ACTIONS_ID_TOKEN_REQUEST_TOKEN|NODE_AUTH_TOKEN|NPM_TOKEN|NPM_CONFIG_USERCONFIG)=' | sed 's/=.*$/=<set>/'

      - name: Publish to npm
        if: steps.release_check.outputs.is_release == 'true'
        run: |
          unset NODE_AUTH_TOKEN
          unset NPM_TOKEN
          export NPM_CONFIG_USERCONFIG=/dev/null
          npm publish --provenance --access public
